(()=>{(function(){let{username:n,frameancestors:a}=document.querySelector("#auth").dataset,r=(a||"").trim().split(/\s+/);function i(t){document.querySelector("#auth-message").textContent=t}async function u(t,o){try{let e=await fetch("/api/ext-auth/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken")},body:JSON.stringify(t)});if(e.status!==200)throw new Error(`Server responded with status ${e.status}.`);let s=await e.json();if(s.status==="badpass")throw new Error("Not logged in.");if(s.status==="banned")throw new Error("Banned.");if(s.status==="outgroup")throw new Error("Not in the required group.");if(s.status!=="auth")throw new Error(`Unknown status '${s.status}'.`);if(!s.token||typeof s.token!="string")throw new Error("Missing token.");window.parent.postMessage({type:"auth-identified",token:s.token},o)}catch(e){console.error(e),i(`Authentication failed: ${e.message}`)}}window.addEventListener("message",t=>{if(r.includes(t.origin))if(t.data?.type==="auth-authenticate"){let e={...t.data.args,username:n,password:!1};u(e,t.origin)}else console.error("Unknown message type",t);else console.warning("Origin not allowed",t)}),window.parent.postMessage({type:"auth-username-selected",username:n},"*")})();})();
